// ==UserScript==
// @name         [megamarket.ru] Show adjusted prices
// @namespace    http://tampermonkey.net/
// @version      1.1.1
// @description  Sorry. Nothing interesting here.
// @author       Persona
// @match        https://megamarket.ru/*
// @icon         https://www.google.com/s2/favicons?sz=64&domain=megamarket.ru
// @grant        none
// ==/UserScript==

"use strict";(()=>{var p="adjustedPrice";function P(e,t,n){console.log(`/*-------------------------- PRICE ADJUSTER -----------------------------------*/
${e.toUpperCase()} MESSAGE: ${t}`+(n?`
${n.message}
${n.stack}`:""))}var C={fg:"white",bg:"#b222ff",border:"black"},y={bg:"#cccccc",fg:"black",border:"transparent"},c={0:{bg:"#00FF22",fg:"black",border:"black"},1:{bg:"#00b621",fg:"white",border:"transparent"},2:{bg:"#f4f44f",fg:"black",border:"transparent"},3:{bg:"#eba000",fg:"white",border:"transparent"},4:{bg:"#AB3131",fg:"white",border:"transparent"},5:{bg:"#540202",fg:"white",border:"transparent"},6:{bg:"#000000",fg:"white",border:"transparent"}};function h(e){var t;let n=(t=/^[\d\s]+/.exec(e.replace(/\s/g,"")))===null||t===void 0?void 0:t[0].trim();return n===void 0?null:parseInt(n)}function g(e){var t;return e.price?e.price-((t=e.bonusAmount)!==null&&t!==void 0?t:0):null}function E(e){function t(n,o){return`<span style="color:${n.fg};font-weight:bold; background-color:${n.bg}; border: 1px solid ${n.border}; padding:0 5px 0;">${o}</span>`}if(e==="BONUS_AMOUNT")return[t(y,"0%"),t(c[5],"1-10%"),t(c[4],"10-20%"),t(c[3],"20-30%"),t(c[2],"30-40%"),t(c[1],"40-50%"),t(c[0],"50-60%"),t(C,"60%+")].join(" ");if(e==="COMPARISON")return[x("\u0422\u041E\u041F 1-5"),...Object.values(c).map((n,o)=>t(n,o.toString()))].join(" ");throw new Error("Type is not supported.")}function _(e){return e>60?C:e>50?c[0]:e>40?c[1]:e>30?c[2]:e>20?c[3]:e>10?c[4]:e>0?c[5]:y}function L(e,t){let n=t[0],o=t[t.length-1],r=t.findIndex(f=>f===e),i=Object.keys(c).length,s=Math.floor(((e-n)/(o-n)+r/t.length)/2*i);return{color:t.length===1?c[0]:c[s<i?s:i-1],position:r+1}}function T(e){let t=e.map(n=>g(n)).filter(n=>n!==null).sort((n,o)=>n-o);return[...new Set(t)]}function A(e,t){return`<span style="color:${t.fg};background-color:${t.bg};border: 1px solid ${t.border};padding: 0px 10px; margin-right: 5px">${e.toLocaleString("ru-RU",{useGrouping:!0})}<span>`}function x(e){return`<span style="color: #5d3a8e;outline: 1px solid #5d3a8e;padding: 0px 15px;">${e}</span> `}function u(e,t){let n=[],o=document.querySelectorAll(e);for(let r of Array.from(o))if(r instanceof HTMLElement&&!r.dataset[p]){let i=r.querySelector(t);!i||!(i instanceof HTMLElement)?(P("error",`"PriceNode" element (selector: "${t}") is not found inside "PriceContainer" element (selector: "${e}").`),r.dataset[p]="1"):n.push({price:null,bonusAmount:null,priceContainerEl:r,priceEl:i})}return n}function l(e,t){return e.map(n=>{let o=n.priceContainerEl;if(o.dataset[p])return n;let r=n.priceEl;if(!r.textContent)return n;let i=h(r.textContent),s=o.querySelectorAll(t)[0];if(!s?.textContent)return{price:i,bonusAmount:0,priceContainerEl:o,priceEl:r};let d=h(s.textContent);return{price:i,bonusAmount:d,priceContainerEl:o,priceEl:r}})}function a(e){e.forEach(t=>{if(t.priceContainerEl.dataset[p])return;let n=g(t);if(n===null||t.price===null||t.bonusAmount===null)return;let o=Math.round(t.bonusAmount/t.price*100),r=_(o),i=document.createElement("span");i.innerHTML=A(n,r),t.priceEl.prepend(i),t.priceContainerEl.dataset[p]="1"})}var m="adjustedPrice",M=2e3;(function(){setInterval(()=>{try{$(),S(),I(),w(),F(),H(),j()}catch(t){t instanceof Error&&P("error","Error happened while executing userscript",t)}},M)})();function j(){if(document.body.dataset[m])return;let e=document.createElement("div");e.innerHTML=`\u041F\u043E \u043F\u0440\u043E\u0446\u0435\u043D\u0442\u0443 \u043D\u0430\u0447\u0438\u0441\u043B\u044F\u0435\u043C\u044B\u0445 \u0431\u0430\u043B\u043B\u043E\u0432: ${E("BONUS_AMOUNT")}<span style="padding-left: 20px;">\u0421\u0440\u0430\u0432\u043D\u0435\u043D\u0438\u0435 \u0446\u0435\u043D \u043F\u043E-\u0432\u043E\u0437\u0440\u0430\u0441\u0442\u0430\u043D\u0438\u044E: </span>${E("COMPARISON")}`,e.style.position="fixed",e.style.bottom="0",e.style.width="100%",e.style.backgroundColor="white",e.style.zIndex="2147483647",e.style.padding="3px 5px",e.style.lineHeight="25px",e.style.borderTop="1px solid #d4d4d4",document.body.appendChild(e),document.body.dataset[m]="1"}function S(){let e=u(".product-offer-price",".product-offer-price__amount");if(e=l(e,".bonus-amount"),e.length===0)return;let t=[],n=0;e.forEach(({price:r})=>{r!==null&&t.push(r)}),n=Math.min(...t);let o=T(e);e.forEach(r=>{if(r.priceContainerEl.dataset[m])return;let i=g(r);if(i===null)return;let{color:s,position:d}=L(i,o),f=document.createElement("span");f.innerHTML=(d<=5?x(d):"")+A(i,s);let b=r.priceContainerEl.querySelectorAll(".product-offer-price__amount")[0];b instanceof HTMLElement&&r.price===n&&(b.style.color="green"),b.prepend(f),r.priceContainerEl.dataset[m]="1"})}function $(){let e=u(".catalog-item__prices-container",".item-price");e=l(e,".bonus-amount"),a(e)}function I(){let e=u(".product-list-item-price",".amount");e=l(e,".bonus-amount"),a(e)}function w(){let e=u(".cart-item-price",".price");e=l(e,".bonus-amount"),a(e)}function F(){let e=u(".goods-item-card__money",".goods-item-card__amount");e=l(e,".bonus-amount"),a(e)}function H(){let e=u(".prod-buy",".sales-block-offer-price__price-final");e=l(e,".bonus-amount"),a(e)}})();
