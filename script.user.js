// ==UserScript==
// @name         [MegaMarket] Show adjusted prices
// @namespace    http://tampermonkey.net/
// @version      1.0.2
// @updateURL    https://oleglegun.github.io/userscript-megamarket.ru/pages/userscript.js
// @downloadURL  https://oleglegun.github.io/userscript-megamarket.ru/pages/userscript.js
// @description  Description
// @author       You
// @match        https://megamarket.ru/*
// @icon         https://www.google.com/s2/favicons?sz=64&domain=megamarket.ru
// @grant        none
// ==/UserScript==

"use strict";(()=>{var d="adjustedPrice";function L(e,t){console.log(`/*-------------------------- PRICE ADJUSTER -----------------------------------*/
${e.toUpperCase()} MESSAGE
  
${t}`)}var b={fg:"white",bg:"#b222ff",border:"black"},E={bg:"#cccccc",fg:"black",border:"transparent"},i=[{bg:"#00FF22",fg:"black",border:"black"},{bg:"#00FF22",fg:"black",border:"transparent"},{bg:"#00b621",fg:"white",border:"transparent"},{bg:"#f4f44f",fg:"black",border:"transparent"},{bg:"#eba000",fg:"white",border:"transparent"},{bg:"#AB3131",fg:"white",border:"transparent"},{bg:"#540202",fg:"white",border:"transparent"},{bg:"#000000",fg:"white",border:"transparent"}],H=[b,...i];function A(){function e(t,n){return`<span style="color:${t.fg}; background-color:${t.bg}; border: 1px solid ${t.border}">${n}</span>`}return[e(b,"&gt; 60%"),e(i[0],"50% - 60%"),e(i[0],"50% - 60%"),e(E,"0%")].join(" ")}function P(e){var t;let n=(t=/^[\d\s]+/.exec(e.replace(/\s/g,"")))===null||t===void 0?void 0:t[0].trim();return n===void 0?null:parseInt(n)}function f(e){return e.price?e.price-(e.bonusAmount||0):null}function _(e){if(e>60)return b;if(e>50)return i[0];if(e===0)return E;let t=i.slice(1);return t[Math.floor(t.length-e/50*t.length)]}function C(e,t){let n=t[0],o=t[t.length-1],r=t.findIndex(p=>p===e),c=Math.floor(((e-n)/(o-n)+r/t.length)/2*i.length);return{color:t.length===1?i[0]:i[c<i.length?c:i.length-1],position:r+1}}function x(e){let t=e.map(n=>f(n)).filter(n=>n!==null).sort((n,o)=>n-o);return[...new Set(t)]}function m(e,t){return`<span style="color:${t.fg};background-color:${t.bg};border: 1px solid ${t.border};padding: 0px 10px;">${e.toLocaleString("ru-RU",{useGrouping:!0})}<span>`}function h(e){return`<span style="color: #5d3a8e;outline: 1px solid #5d3a8e;padding: 0px 16px;">${e}</span> `}function l(e,t){let n=[],o=document.querySelectorAll(e);for(let r of o)if(r instanceof HTMLElement&&!r.dataset[d]){let c=r.querySelector(t);!c||!(c instanceof HTMLElement)?(console.log(r,c),L("error",`"PriceNode" element (selector: "${t}") is not found inside "PriceContainer" element (selector: "${e}").`),r.dataset[d]="1"):n.push({price:null,bonusAmount:null,priceContainerEl:r,priceEl:c})}return n}function u(e,t){return e.map(n=>{let o=n.priceContainerEl;if(o.dataset[d])return n;let r=n.priceEl;if(!r.textContent)return n;let c=P(r.textContent),s=o.querySelectorAll(t)[0];if(!s||!s.textContent)return{price:c,bonusAmount:0,priceContainerEl:o,priceEl:r};let p=P(s.textContent);return{price:c,bonusAmount:p,priceContainerEl:o,priceEl:r}})}function a(e){e.forEach(t=>{if(t.priceContainerEl.dataset[d])return;let n=f(t);if(n===null||t.price===null||t.bonusAmount===null)return;let o=Math.round(t.bonusAmount/t.price*100),r=_(o),c=document.createElement("span");c.innerHTML=m(n,r),t.priceEl.prepend(c),t.priceContainerEl.dataset[d]="1"})}var g="adjustedPrice";(function(){setInterval(()=>{F(),y(),M(),T(),I(),$(),j()},2e3)})();function j(){if(!document.body.dataset[g]){let e=document.createElement("div");e.innerHTML="\u041F\u043E \u043F\u0440\u043E\u0446\u0435\u043D\u0442\u0443 \u043D\u0430\u0447\u0438\u0441\u043B\u044F\u0435\u043C\u044B\u0445 \u0431\u0430\u043B\u043B\u043E\u0432: "+A(),e.style.position="fixed",e.style.bottom="0",e.style.width="100%",e.style.backgroundColor="white",e.style.zIndex="2147483647",document.body.appendChild(e),document.body.dataset[g]="1"}}function y(){let e=l(".product-offer-price",".product-offer-price__amount");e=u(e,".bonus-amount");let t=x(e);e.forEach(n=>{if(n.priceContainerEl.dataset[g])return;let o=f(n);if(o===null)return;let{color:r,position:c}=C(o,t),s=document.createElement("span");s.innerHTML=(c<=5?h(c):"")+m(o,r),n.priceContainerEl.querySelectorAll(".product-offer-price__amount")[0].prepend(s),n.priceContainerEl.dataset[g]="1"})}function F(){let e=l(".catalog-item__prices-container",".item-price");e=u(e,".bonus-amount"),a(e)}function M(){let e=l(".product-list-item-price",".amount");e=u(e,".bonus-amount"),a(e)}function T(){let e=l(".cart-item-price",".price");e=u(e,".bonus-amount"),a(e)}function I(){let e=l(".goods-item-card__money",".goods-item-card__amount");e=u(e,".bonus-amount"),a(e)}function $(){let e=l(".prod-buy",".sales-block-offer-price__price-final");e=u(e,".bonus-amount"),a(e)}})();
